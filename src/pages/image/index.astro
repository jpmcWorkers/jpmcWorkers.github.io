---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import {
  filterEntriesByPath,
  getBreadcrumbs,
  getImagePath,
} from '../../utils/imageUtils';

/**
 * Pre-import all images using glob from public directory
 * This allows Astro to optimize and process images at build time
 */
const allImages = import.meta.glob('/public/images/**/*.{png,jpg,jpeg,webp,gif}', {
  eager: true,
});

/**
 * Get all image entries from the collection
 */
const allImageEntries = await getCollection('images');

/**
 * Filter to show only root-level items (parentPath === '')
 */
const rootEntries = filterEntriesByPath(allImageEntries, '');

/**
 * Generate breadcrumb navigation (just the root level)
 */
const breadcrumbs = getBreadcrumbs('');

/**
 * Calculate display dimensions for images while maintaining aspect ratio
 * 
 * @param width - Original image width
 * @param height - Original image height
 * @param maxSize - Maximum dimension size (default: 300px)
 * @returns Calculated display dimensions
 */
function calculateDisplayDimensions(
  width?: number,
  height?: number,
  maxSize: number = 300
): { width: number; height: number } {
  if (!width || !height) {
    return { width: maxSize, height: maxSize };
  }

  // Scale based on the larger dimension
  const maxDimension = Math.max(width, height);
  const scaleFactor = Math.min(maxSize / maxDimension, 1); // Don't upscale

  return {
    width: Math.round(width * scaleFactor),
    height: Math.round(height * scaleFactor),
  };
}
---

<Layout title="Images - JPMC Workers Alliance">
  <div class="prose prose-lg max-w-none">
    <h1 class="text-4xl font-bold text-jpmc-blue mb-8">Images & Materials</h1>

    {/* Breadcrumb Navigation */}
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex flex-wrap items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
        {breadcrumbs.map((crumb, index) => (
          <li class="flex items-center">
            {index > 0 && (
              <span class="mx-2 text-gray-400 dark:text-gray-500">/</span>
            )}
            {index === breadcrumbs.length - 1 ? (
              <span class="text-gray-900 dark:text-white font-medium">{crumb.name}</span>
            ) : (
              <a
                href={crumb.path}
                class="text-jpmc-blue hover:text-jpmc-blue-700 hover:underline transition-colors"
              >
                {crumb.name}
              </a>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <div class="mb-8">
      <p class="text-xl text-gray-700 dark:text-gray-300">
        Download and share these images and resources to support the JPMC Workers Alliance.
      </p>
    </div>

    {rootEntries.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400 text-lg">
          No images or folders found.
        </p>
      </div>
    ) : (
      <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-6">
        {rootEntries.map(async (entry) => {
          // For folders, prioritize preview file first, then fall back to main file
          // For regular files, use the file itself
          const isFolder = entry.data.isFolder;
          
          // Determine which image to use - for folders, prefer preview if available
          const imageToUse = isFolder && entry.data.preview
            ? entry.data.preview
            : (isFolder ? entry.data.file : entry.data.file);
          
          // Use preview dimensions if preview exists, otherwise use file dimensions
          const dimensionsToUse = entry.data.preview
            ? {
                width: entry.data.previewWidth || entry.data.width,
                height: entry.data.previewHeight || entry.data.height,
              }
            : { width: entry.data.width, height: entry.data.height };

          const displayDimensions = calculateDisplayDimensions(
            dimensionsToUse.width,
            dimensionsToUse.height,
            300
          );

          // Get the image path and normalize it for the glob lookup
          // Glob keys use forward slashes: /public/images/Abstract Agitation/preview.png
          const imagePath = getImagePath(imageToUse).replace(/\\/g, '/');
          const imageModule = allImages[imagePath] as { default: any } | undefined;
          // For folder URLs, encode each path segment separately to preserve slashes
          // This matches how getStaticPaths generates the paths
          const folderUrl = isFolder
            ? `/image/${entry.data.relativePath.split('/').map(encodeURIComponent).join('/')}`
            : null;
          const downloadUrl = !isFolder ? `/images/${entry.data.relativePath}` : null;

          return (
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden border-2 border-gray-200 dark:border-gray-700 flex flex-col">
              {/* Preview Image */}
              <div class="aspect-square dark:bg-gray-700 flex items-center justify-center">
                {entry.data.type.toLowerCase() === 'pdf' &&
                !entry.data.preview?.trim() ? (
                  <div class="text-gray-500 dark:text-gray-400 flex items-center justify-center p-4 min-h-[250px] object-cover">
                    <span>No Preview Available</span>
                  </div>
                ) : imageModule ? (
                  <Image
                    width={displayDimensions.width}
                    height={displayDimensions.height}
                    src={imageModule.default}
                    alt={entry.data.name}
                    loading="lazy"
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="text-gray-500 dark:text-gray-400 flex items-center justify-center p-4 min-h-[250px] object-cover">
                    <span>Image not found: {imageToUse}</span>
                  </div>
                )}
              </div>

              {/* Content */}
              <div class="p-4 flex flex-col flex-grow">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 truncate">
                  {entry.data.name.replace(/\.[^/.]+$/, '')}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                  {entry.data.type.toUpperCase()} â€¢{' '}
                  {isFolder ? 'Folder' : 'File'}
                </p>

                {/* Action Button */}
                {isFolder ? (
                  <a
                    href={folderUrl!}
                    class="inline-block w-full bg-jpmc-blue text-white text-center px-4 py-2 rounded-md hover:bg-jpmc-blue-700 transition-colors"
                  >
                    Open Folder
                  </a>
                ) : (
                  <a
                    href={downloadUrl!}
                    download={entry.data.file.split('/').pop()}
                    class="inline-block w-full bg-jpmc-blue text-white text-center px-4 py-2 rounded-md hover:bg-jpmc-blue-700 transition-colors"
                  >
                    Download
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>
</Layout>

 