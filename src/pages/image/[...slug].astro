---
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import {
  filterEntriesByPath,
  getBreadcrumbs,
  getImagePath,
  decodeFolderPath,
} from '../../utils/imageUtils';
import { getImageFolderPaths } from '../../utils/imagePaths';

export const getStaticPaths = getImageFolderPaths;

const allImages = import.meta.glob('/public/images/**/*.{png,jpg,jpeg,webp,gif}', { eager: true });
const allImageEntries = await getCollection('images');

const folderPathFromProps = Astro.props.folderPath as string | undefined;
const { slug } = Astro.params;
// Handle slug parameter - it can be string or number, but for our use case it should be a string
const slugString = typeof slug === 'string' ? slug : String(slug || '');
const folderPath: string = folderPathFromProps || (slugString 
  ? slugString.split('/').map(decodeURIComponent).join('/')
  : '');

const currentEntries = filterEntriesByPath(allImageEntries, folderPath);
const breadcrumbs = getBreadcrumbs(folderPath);

function calculateDisplayDimensions(
  width?: number,
  height?: number,
  maxSize: number = 300
): { width: number; height: number } {
  if (!width || !height) {
    return { width: maxSize, height: maxSize };
  }
  const maxDimension = Math.max(width, height);
  const scaleFactor = Math.min(maxSize / maxDimension, 1);
  return {
    width: Math.round(width * scaleFactor),
    height: Math.round(height * scaleFactor),
  };
}

const pageTitle = folderPath
  ? `${folderPath.split('/').pop()} - Images & Materials`
  : 'Images & Materials';
---

<Layout title={`${pageTitle} - JPMC Workers Alliance`}>
  <div class="prose prose-lg max-w-none">
    <h1 class="text-4xl font-bold text-jpmc-blue mb-8">Images & Materials</h1>

    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex flex-wrap items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
        {breadcrumbs.map((crumb, index) => (
          <li class="flex items-center">
            {index > 0 && (
              <span class="mx-2 text-gray-400 dark:text-gray-500">/</span>
            )}
            {index === breadcrumbs.length - 1 ? (
              <span class="text-gray-900 dark:text-white font-medium">{crumb.name}</span>
            ) : (
              <a
                href={crumb.path}
                class="text-jpmc-blue hover:text-jpmc-blue-700 hover:underline transition-colors"
              >
                {crumb.name}
              </a>
            )}
          </li>
        ))}
      </ol>
    </nav>

    <div class="mb-8">
      <p class="text-xl text-gray-700 dark:text-gray-300">
        {folderPath
          ? `Contents of "${folderPath.split('/').pop()}"`
          : 'Download and share these images and resources to support the JPMC Workers Alliance.'}
      </p>
    </div>

    {currentEntries.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400 text-lg">
          This folder is empty.
        </p>
      </div>
    ) : (
      <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-6">
        {currentEntries.map(async (entry) => {
          const imageToUse = entry.data.preview || entry.data.file;
          const dimensionsToUse = entry.data.preview
            ? {
                width: entry.data.previewWidth,
                height: entry.data.previewHeight,
              }
            : { width: entry.data.width, height: entry.data.height };

          const displayDimensions = calculateDisplayDimensions(
            dimensionsToUse.width,
            dimensionsToUse.height,
            300
          );

          const imagePath = getImagePath(imageToUse);
          const imageModule = allImages[imagePath] as { default: any } | undefined;

          const isFolder = entry.data.isFolder;
          const folderUrl = isFolder
            ? `/image/${entry.data.relativePath.split('/').map(encodeURIComponent).join('/')}`
            : null;
          const downloadUrl = !isFolder ? `/images/${entry.data.relativePath}` : null;

          return (
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden border-2 border-gray-200 dark:border-gray-700 flex flex-col">
              <div class="aspect-square dark:bg-gray-700 flex items-center justify-center">
                {entry.data.type.toLowerCase() === 'pdf' &&
                !entry.data.preview?.trim() ? (
                  <div class="text-gray-500 dark:text-gray-400 flex items-center justify-center p-4 min-h-[250px] object-cover">
                    <span>No Preview Available</span>
                  </div>
                ) : imageModule ? (
                  <Image
                    width={displayDimensions.width}
                    height={displayDimensions.height}
                    src={imageModule.default}
                    alt={entry.data.name}
                    loading="lazy"
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="text-gray-500 dark:text-gray-400 flex items-center justify-center p-4 min-h-[250px] object-cover">
                    <span>Image not found: {imageToUse}</span>
                  </div>
                )}
              </div>

              <div class="p-4 flex flex-col flex-grow">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 truncate">
                  {entry.data.name.replace(/\.[^/.]+$/, '')}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                  {entry.data.type.toUpperCase()} â€¢{' '}
                  {isFolder ? 'Folder' : 'File'}
                </p>

                {isFolder ? (
                  <a
                    href={folderUrl!}
                    class="inline-block w-full bg-jpmc-blue text-white text-center px-4 py-2 rounded-md hover:bg-jpmc-blue-700 transition-colors"
                  >
                    Open Folder
                  </a>
                ) : (
                  <a
                    href={downloadUrl!}
                    download={entry.data.file.split('/').pop()}
                    class="inline-block w-full bg-jpmc-blue text-white text-center px-4 py-2 rounded-md hover:bg-jpmc-blue-700 transition-colors"
                  >
                    Download
                  </a>
                )}
              </div>
            </div>
          );
        })}
      </div>
    )}
  </div>
</Layout>
